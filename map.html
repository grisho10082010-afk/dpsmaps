<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Карта</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
</head>
<body>
<div id="map"></div>

<div class="panel">
  <b id="title">Карта</b>
  <div id="status">Загрузка…</div>
  <button id="fitCity">Показать город</button>
  <button id="fitPoints">Показать точки</button>
  <div class="small">Если “мира нет” — переключи слой OSM/CARTO.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(async () => {
  const titleEl = document.getElementById("title");
  const statusEl = document.getElementById("status");
  const fitCityBtn = document.getElementById("fitCity");
  const fitPointsBtn = document.getElementById("fitPoints");
  const setStatus = (html) => statusEl.innerHTML = html;

  function parseISO(val) {
    if (!val) return null;
    try { return new Date(val); } catch { return null; }
  }
  function agoText(iso) {
    const d = parseISO(iso);
    if (!d || isNaN(d.getTime())) return "неизвестно";
    const ms = Date.now() - d.getTime();
    const sec = Math.max(0, Math.floor(ms / 1000));
    const min = Math.floor(sec / 60);
    const hr = Math.floor(min / 60);
    const day = Math.floor(hr / 24);
    if (day > 0) return `${day} дн. назад`;
    if (hr > 0) return `${hr} ч. назад`;
    if (min > 0) return `${min} мин. назад`;
    return `${sec} сек. назад`;
  }

  const cfg = await (await fetch("/config", { cache: "no-store" })).json();
  titleEl.textContent = `Карта: ${cfg.city_name} (TTL ${cfg.ttl_hours}ч)`;

  const cityLat = Number(cfg.center.lat);
  const cityLon = Number(cfg.center.lon);

  const map = L.map("map", { zoomControl: true }).setView([cityLat, cityLon], 11);

  // 2 слоя: если OSM вдруг не грузится, можно переключить
  const osm = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 });
  const carto = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
    subdomains: "abcd", maxZoom: 19
  });

  osm.addTo(map);
  L.control.layers({ "OSM": osm, "CARTO (fallback)": carto }, {}, { collapsed: true }).addTo(map);

  let tilesOk = false;
  const markOk = (name) => { tilesOk = true; setStatus(`<span class="ok">OK:</span> тайлы (${name}), точки грузятся…`); };
  const markBad = () => { if (!tilesOk) setStatus(`<span class="bad">Проблема:</span> тайлы не грузятся. Переключи на <b>CARTO</b>.`); };

  osm.on("tileload", () => markOk("OSM"));
  osm.on("tileerror", markBad);
  carto.on("tileload", () => markOk("CARTO"));
  carto.on("tileerror", markBad);

  const layer = L.layerGroup().addTo(map);
  let lastBounds = null;

  function arrowIcon(bearingDeg){
    const html = `<div class="arrow-marker" style="transform: rotate(${bearingDeg}deg);"></div>`;
    return L.divIcon({ html, className: "", iconSize: [24, 24], iconAnchor: [12, 12] });
  }

  async function loadPoints(fit=false) {
    const points = await (await fetch("/places", { cache: "no-store" })).json();

    layer.clearLayers();
    const latlngs = [];

    for (const p of points) {
      const lat = Number(p.lat);
      const lon = Number(p.lon);
      if (!isFinite(lat) || !isFinite(lon)) continue;

      const seen = p.last_seen_at || p.created_at;
      const age = agoText(seen);
      const conf = Number(p.confirmations || 1);

      let m;
      if (p.bearing !== null && p.bearing !== undefined && isFinite(Number(p.bearing))) {
        m = L.marker([lat, lon], { icon: arrowIcon(Number(p.bearing)) }).addTo(layer);
      } else {
        m = L.marker([lat, lon]).addTo(layer);
      }

      const tip = `${p.name} • ${age} • подтверждений: ${conf}`;
      m.bindTooltip(tip, { direction: "top", opacity: 0.95 });
      m.bindPopup(`<b>${p.name}</b><br>Как давно: <b>${age}</b><br>Подтверждений: <b>${conf}</b>`);

      latlngs.push([lat, lon]);
    }

    if (latlngs.length > 0) {
      lastBounds = L.latLngBounds(latlngs);
      if (fit) map.fitBounds(lastBounds.pad(0.35));
    } else {
      lastBounds = null;
    }

    if (tilesOk) setStatus(`<span class="ok">OK:</span> точек: <b>${latlngs.length}</b>`);
    else setStatus(`Точек: <b>${latlngs.length}</b> (если “мира нет” — переключи слой)`);
  }

  fitCityBtn.onclick = () => map.setView([cityLat, cityLon], 11);
  fitPointsBtn.onclick = () => {
    if (lastBounds) map.fitBounds(lastBounds.pad(0.35));
    else alert("Пока нет точек.");
  };

  await loadPoints(true);
  setInterval(() => loadPoints(false), 5000);
})();
</script>
</body>
</html>
